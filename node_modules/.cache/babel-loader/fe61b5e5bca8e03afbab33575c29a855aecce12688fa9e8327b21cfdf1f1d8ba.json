{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useEffect, useRef, useState, useCallback } from 'react';\nimport { calculateInitialEMA, updateEMA } from '../utils/ema';\n\n// Hook options: { symbol }\nexport default function useEmaCross({\n  symbol = 'BTCUSDT'\n} = {}) {\n  _s();\n  const [ema26, setEma26] = useState(null);\n  const [ema200, setEma200] = useState(null);\n  const [lastPrice, setLastPrice] = useState(null);\n  const [cross, setCross] = useState(null); // 'bull' | 'bear' | null\n  const [connected, setConnected] = useState(false);\n  const [status, setStatus] = useState('idle');\n  const [lastCandleClosed, setLastCandleClosed] = useState(false);\n  const wsRef = useRef(null);\n  const prevCrossRef = useRef(null);\n  const ema26Ref = useRef(null);\n  const ema200Ref = useRef(null);\n  const fetchAndInit = useCallback(async () => {\n    try {\n      setStatus('fetching historical klines');\n      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=5m&limit=500`;\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(`Failed to fetch klines: ${res.status}`);\n      const data = await res.json();\n      // kline array: [ openTime, open, high, low, close, ... ]\n      const closes = data.map(k => parseFloat(k[4]));\n      if (closes.length < 200) throw new Error('Not enough historical candles to initialize EMA200');\n\n      // Use the full close history to compute EMA values\n      const initEma26 = calculateInitialEMA(closes.slice(-300), 26);\n      const initEma200 = calculateInitialEMA(closes.slice(-500), 200);\n      ema26Ref.current = initEma26;\n      ema200Ref.current = initEma200;\n      setEma26(initEma26);\n      setEma200(initEma200);\n      setLastPrice(closes[closes.length - 1]);\n      setStatus('initialized');\n      // set initial cross\n      const initialCross = initEma26 > initEma200 ? 'bull' : 'bear';\n      prevCrossRef.current = initialCross;\n      setCross(initialCross);\n    } catch (err) {\n      setStatus(`init error: ${err.message}`);\n      console.error(err);\n    }\n  }, [symbol]);\n  const connect = useCallback(() => {\n    if (wsRef.current) return;\n    setStatus('connecting websocket');\n    const stream = `${symbol.toLowerCase()}@kline_5m`;\n    const url = `wss://stream.binance.com:9443/ws/${stream}`;\n    const ws = new WebSocket(url);\n    wsRef.current = ws;\n    ws.onopen = () => {\n      setConnected(true);\n      setStatus('connected');\n    };\n    ws.onmessage = ev => {\n      try {\n        const data = JSON.parse(ev.data);\n        const k = data.k;\n        if (k) {\n          // Use the current close price of the kline (partial or closed)\n          const close = parseFloat(k.c);\n          setLastPrice(close);\n\n          // Ensure we have initial EMAs\n          if (ema26Ref.current == null || ema200Ref.current == null) return;\n\n          // Update EMAs on every incoming kline update so the UI shows live EMA\n          const newEma26 = updateEMA(ema26Ref.current, close, 26);\n          const newEma200 = updateEMA(ema200Ref.current, close, 200);\n          ema26Ref.current = newEma26;\n          ema200Ref.current = newEma200;\n          setEma26(newEma26);\n          setEma200(newEma200);\n          const newCross = newEma26 > newEma200 ? 'bull' : 'bear';\n          if (prevCrossRef.current !== newCross) {\n            prevCrossRef.current = newCross;\n            setCross(newCross);\n          }\n        }\n      } catch (err) {\n        console.error('ws message parse error', err);\n      }\n    };\n    ws.onerror = e => {\n      console.error('ws error', e);\n      setStatus('websocket error');\n    };\n    ws.onclose = () => {\n      setConnected(false);\n      setStatus('websocket closed');\n      wsRef.current = null;\n      // auto-reconnect after a short delay\n      setTimeout(() => {\n        if (!wsRef.current) connect();\n      }, 5000);\n    };\n  }, [symbol]);\n  const disconnect = useCallback(() => {\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setConnected(false);\n    setStatus('disconnected');\n  }, []);\n  useEffect(() => {\n    // initialize on mount (or when symbol changes)\n    fetchAndInit();\n    // cleanup on unmount\n    return () => {\n      if (wsRef.current) wsRef.current.close();\n    };\n  }, [fetchAndInit]);\n  return {\n    ema26,\n    ema200,\n    lastPrice,\n    lastCandleClosed,\n    cross,\n    connected,\n    status,\n    connect,\n    disconnect\n  };\n}\n_s(useEmaCross, \"vLSE35htJ2IzqU2YqefL+Ur4vIM=\");","map":{"version":3,"names":["useEffect","useRef","useState","useCallback","calculateInitialEMA","updateEMA","useEmaCross","symbol","_s","ema26","setEma26","ema200","setEma200","lastPrice","setLastPrice","cross","setCross","connected","setConnected","status","setStatus","lastCandleClosed","setLastCandleClosed","wsRef","prevCrossRef","ema26Ref","ema200Ref","fetchAndInit","url","res","fetch","ok","Error","data","json","closes","map","k","parseFloat","length","initEma26","slice","initEma200","current","initialCross","err","message","console","error","connect","stream","toLowerCase","ws","WebSocket","onopen","onmessage","ev","JSON","parse","close","c","newEma26","newEma200","newCross","onerror","e","onclose","setTimeout","disconnect"],"sources":["C:/Users/e1it3/Desktop/program/binance_alert/src/hooks/useEmaCross.js"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { calculateInitialEMA, updateEMA } from '../utils/ema';\r\n\r\n// Hook options: { symbol }\r\nexport default function useEmaCross({ symbol = 'BTCUSDT' } = {}) {\r\n  const [ema26, setEma26] = useState(null);\r\n  const [ema200, setEma200] = useState(null);\r\n  const [lastPrice, setLastPrice] = useState(null);\r\n  const [cross, setCross] = useState(null); // 'bull' | 'bear' | null\r\n  const [connected, setConnected] = useState(false);\r\n  const [status, setStatus] = useState('idle');\r\n  const [lastCandleClosed, setLastCandleClosed] = useState(false);\r\n\r\n  const wsRef = useRef(null);\r\n  const prevCrossRef = useRef(null);\r\n  const ema26Ref = useRef(null);\r\n  const ema200Ref = useRef(null);\r\n\r\n  const fetchAndInit = useCallback(async () => {\r\n    try {\r\n      setStatus('fetching historical klines');\r\n      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=5m&limit=500`;\r\n      const res = await fetch(url);\r\n      if (!res.ok) throw new Error(`Failed to fetch klines: ${res.status}`);\r\n      const data = await res.json();\r\n      // kline array: [ openTime, open, high, low, close, ... ]\r\n      const closes = data.map((k) => parseFloat(k[4]));\r\n\r\n      if (closes.length < 200) throw new Error('Not enough historical candles to initialize EMA200');\r\n\r\n      // Use the full close history to compute EMA values\r\n      const initEma26 = calculateInitialEMA(closes.slice(-300), 26);\r\n      const initEma200 = calculateInitialEMA(closes.slice(-500), 200);\r\n\r\n      ema26Ref.current = initEma26;\r\n      ema200Ref.current = initEma200;\r\n      setEma26(initEma26);\r\n      setEma200(initEma200);\r\n      setLastPrice(closes[closes.length - 1]);\r\n      setStatus('initialized');\r\n      // set initial cross\r\n      const initialCross = initEma26 > initEma200 ? 'bull' : 'bear';\r\n      prevCrossRef.current = initialCross;\r\n      setCross(initialCross);\r\n    } catch (err) {\r\n      setStatus(`init error: ${err.message}`);\r\n      console.error(err);\r\n    }\r\n  }, [symbol]);\r\n\r\n  const connect = useCallback(() => {\r\n    if (wsRef.current) return;\r\n    setStatus('connecting websocket');\r\n    const stream = `${symbol.toLowerCase()}@kline_5m`;\r\n    const url = `wss://stream.binance.com:9443/ws/${stream}`;\r\n    const ws = new WebSocket(url);\r\n    wsRef.current = ws;\r\n\r\n    ws.onopen = () => {\r\n      setConnected(true);\r\n      setStatus('connected');\r\n    };\r\n\r\n    ws.onmessage = (ev) => {\r\n      try {\r\n        const data = JSON.parse(ev.data);\r\n        const k = data.k;\r\n        if (k) {\r\n          // Use the current close price of the kline (partial or closed)\r\n          const close = parseFloat(k.c);\r\n          setLastPrice(close);\r\n\r\n          // Ensure we have initial EMAs\r\n          if (ema26Ref.current == null || ema200Ref.current == null) return;\r\n\r\n          // Update EMAs on every incoming kline update so the UI shows live EMA\r\n          const newEma26 = updateEMA(ema26Ref.current, close, 26);\r\n          const newEma200 = updateEMA(ema200Ref.current, close, 200);\r\n\r\n          ema26Ref.current = newEma26;\r\n          ema200Ref.current = newEma200;\r\n\r\n          setEma26(newEma26);\r\n          setEma200(newEma200);\r\n\r\n          const newCross = newEma26 > newEma200 ? 'bull' : 'bear';\r\n          if (prevCrossRef.current !== newCross) {\r\n            prevCrossRef.current = newCross;\r\n            setCross(newCross);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('ws message parse error', err);\r\n      }\r\n    };\r\n\r\n    ws.onerror = (e) => {\r\n      console.error('ws error', e);\r\n      setStatus('websocket error');\r\n    };\r\n\r\n    ws.onclose = () => {\r\n      setConnected(false);\r\n      setStatus('websocket closed');\r\n      wsRef.current = null;\r\n      // auto-reconnect after a short delay\r\n      setTimeout(() => {\r\n        if (!wsRef.current) connect();\r\n      }, 5000);\r\n    };\r\n  }, [symbol]);\r\n\r\n  const disconnect = useCallback(() => {\r\n    if (wsRef.current) {\r\n      wsRef.current.close();\r\n      wsRef.current = null;\r\n    }\r\n    setConnected(false);\r\n    setStatus('disconnected');\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // initialize on mount (or when symbol changes)\r\n    fetchAndInit();\r\n    // cleanup on unmount\r\n    return () => {\r\n      if (wsRef.current) wsRef.current.close();\r\n    };\r\n  }, [fetchAndInit]);\r\n\r\n  return {\r\n    ema26,\r\n    ema200,\r\n    lastPrice,\r\n    lastCandleClosed,\r\n    cross,\r\n    connected,\r\n    status,\r\n    connect,\r\n    disconnect,\r\n  };\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}