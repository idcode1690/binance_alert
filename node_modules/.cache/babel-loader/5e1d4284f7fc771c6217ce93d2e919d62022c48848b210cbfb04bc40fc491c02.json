{"ast":null,"code":"import{useEffect,useRef,useState,useCallback}from'react';import{calculateInitialEMA,updateEMA}from'../utils/ema';// Hook options: { symbol }\nexport default function useEmaCross(){let{symbol='BTCUSDT',autoConnect=true,debug=false}=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const[ema9,setEma9]=useState(null);const[ema26,setEma26]=useState(null);const[lastPrice,setLastPrice]=useState(null);// lastTick represents the most recent trade/partial-candle price (live preview).\n// lastPrice remains reserved for the most recent CLOSED candle price and is\n// used when emitting confirmed alerts/notifications.\n// eslint-disable-next-line no-unused-vars\nconst[lastTick,setLastTick]=useState(null);// when debug is enabled, log lastTick updates so the variable is visibly used\n// inside this module (and also helpful for debugging live preview values).\nuseEffect(()=>{try{if(debug&&typeof lastTick!=='undefined'&&lastTick!==null){// lightweight debug output\n// eslint-disable-next-line no-console\nconsole.debug('[useEmaCross] lastTick',lastTick);}}catch(e){}},[lastTick,debug]);const[cross,setCross]=useState(null);// preview (live) cross\nconst[confirmedCross,setConfirmedCross]=useState(null);// only updated on closed candles (confirmed)\nconst[confirmedSource,setConfirmedSource]=useState(null);// 'ws' | 'poll' | 'init'\nconst[connected,setConnected]=useState(false);const[status,setStatus]=useState('idle');const[lastCandleClosed,setLastCandleClosed]=useState(false);const[activeSymbol,setActiveSymbol]=useState(null);// which symbol the hook has initialized/connected for\nconst wsRef=useRef(null);const prevCrossRef=useRef(null);const prevConfirmedRef=useRef(null);const ema9Ref=useRef(null);const ema26Ref=useRef(null);// confirmed EMAs updated only on closed candles (kline.x === true) or polling\nconst ema9ConfirmedRef=useRef(null);const ema26ConfirmedRef=useRef(null);const reconnectAttemptsRef=useRef(0);const reconnectTimerRef=useRef(null);const currentSymbolRef=useRef(null);const lastProcessedCloseRef=useRef(null);// timestamp (ms) of last processed closed candle\nconst pollingTimerRef=useRef(null);const replacementInProgressRef=useRef(false);const fetchAndInit=useCallback(async function(){let target=arguments.length>0&&arguments[0]!==undefined?arguments[0]:symbol;try{const t=(target||symbol).toString();setStatus('fetching historical klines');const norm=t.replace(/[^A-Za-z0-9]/g,'').toUpperCase();// use Binance Futures (USDT-M) REST endpoint for klines (5m)\nconst url=\"https://fapi.binance.com/fapi/v1/klines?symbol=\".concat(norm,\"&interval=5m&limit=500\");const res=await fetch(url);if(!res.ok)throw new Error(\"Failed to fetch klines: \".concat(res.status));const data=await res.json();// kline array: [ openTime, open, high, low, close, ... ]\nconst closes=data.map(k=>parseFloat(k[4]));// Allow initializing EMAs with shorter history in tests or when full\n// long-period history isn't available. Use the available history length\n// as the seed period when it's smaller than the configured EMA period.\nconst shortPeriod=26;// short EMA (26)\nconst longPeriod=200;// long EMA (200)\nconst seedShort=Math.min(closes.length,shortPeriod);const seedLong=Math.min(closes.length,longPeriod);const initEma9=calculateInitialEMA(closes,seedShort);const initEma26=calculateInitialEMA(closes,seedLong);// initialize both preview and confirmed EMAs from historical closes\nema9Ref.current=initEma9;ema26Ref.current=initEma26;ema9ConfirmedRef.current=initEma9;ema26ConfirmedRef.current=initEma26;// record which symbol these EMAs correspond to\ncurrentSymbolRef.current=norm;setActiveSymbol(norm);// record last processed closed candle time (closeTime at index 6)\ntry{lastProcessedCloseRef.current=data[data.length-1][6];}catch(e){lastProcessedCloseRef.current=null;}setEma9(initEma9);setEma26(initEma26);setLastPrice(closes[closes.length-1]);// indicate initialized\nsetStatus('initialized');// mark that initial seeding completed; tests expect an 'init' source\nsetConfirmedSource('init');// debug trace for tests\ntry{if(debug)console.debug('[useEmaCross] fetchAndInit completed for',norm,'closes=',closes.length);}catch(e){}// set initial cross\nconst initialCross=initEma9>initEma26?'bull':'bear';prevCrossRef.current=initialCross;setCross(initialCross);prevConfirmedRef.current=initialCross;setConfirmedCross(initialCross);setConfirmedSource('init');}catch(err){setStatus(\"init error: \".concat(err.message));console.error(err);}},[symbol,debug]);const connect=useCallback(async overrideSymbol=>{const targetSymbol=(overrideSymbol||symbol).toString();const targetNorm=targetSymbol.replace(/[^A-Za-z0-9]/g,'').toUpperCase();// if a websocket exists for same symbol, no-op\nif(wsRef.current){if(currentSymbolRef.current===targetNorm)return;// do NOT close the existing socket here; create a new socket and let the\n// new socket's onopen handler replace/close the old socket to avoid a\n// brief disconnected state in the UI.\n}// Ensure EMA is initialized for the target symbol before connecting\ntry{const targetNorm=targetSymbol.replace(/[^A-Za-z0-9]/g,'').toUpperCase();if(currentSymbolRef.current!==targetNorm||ema9Ref.current==null||ema26Ref.current==null){await fetchAndInit(targetNorm);}}catch(err){setStatus(\"init error: \".concat(err.message));return;}setStatus('connecting websocket');// Use combined stream: kline_5m + aggTrade for higher-frequency trade updates\nconst klineStream=\"\".concat(targetNorm.toLowerCase(),\"@kline_5m\");const tradeStream=\"\".concat(targetNorm.toLowerCase(),\"@aggTrade\");const streams=\"\".concat(klineStream,\"/\").concat(tradeStream);// use Binance Futures (USDT-M) websocket (fstream) combined stream\nconst url=\"wss://fstream.binance.com/stream?streams=\".concat(streams);console.log('Connecting websocket for',targetSymbol,'url=',url);const ws=new WebSocket(url);// mark that we're starting a replacement sequence so temporary closes\n// of the old socket don't flip the connected flag in the UI\nreplacementInProgressRef.current=true;// Keep the UI connected while replacing sockets to avoid a brief disconnect\n// state during symbol switches. We'll set the definitive connected state\n// on the socket's onopen/onclose handlers.\ntry{setConnected(true);}catch(e){}// Do not overwrite wsRef.current immediately. Create a new socket and only replace the\n// existing one after the new socket successfully opens. This allows a seamless symbol\n// switch without briefly showing disconnected state in the UI.\nconst oldWs=wsRef.current;ws.onopen=()=>{// mark as successful open\nreconnectAttemptsRef.current=0;if(reconnectTimerRef.current){clearTimeout(reconnectTimerRef.current);reconnectTimerRef.current=null;}// stop polling if it was started while socket was down\nif(pollingTimerRef.current){clearInterval(pollingTimerRef.current);pollingTimerRef.current=null;}// If there was a previous socket, mark it as replaced so its onclose handler\n// skips reconnect logic, then close it.\ntry{if(oldWs){oldWs.__replaced=true;try{oldWs.close();}catch(e){}}}catch(e){}// replacement finished\nreplacementInProgressRef.current=false;// now adopt the new socket as the active socket\nwsRef.current=ws;currentSymbolRef.current=targetNorm;setActiveSymbol(targetNorm);if(debug)console.log('[useEmaCross] websocket open for',targetNorm);console.log('[useEmaCross] websocket onopen for',targetNorm,'oldWs?',!!oldWs);setConnected(true);setStatus('connected');};ws.onmessage=ev=>{try{const payloadWrapper=JSON.parse(ev.data);// combined stream returns { stream, data }\nconst payload=payloadWrapper.data||payloadWrapper;// determine the source symbol for this message (if available)\nlet sourceSymbol=null;try{if(payload&&payload.s)sourceSymbol=payload.s.toString().toUpperCase();else if(payloadWrapper&&payloadWrapper.stream){const streamName=payloadWrapper.stream.toString();// e.g. trxusdt@aggTrade\nsourceSymbol=streamName.split('@')[0].toUpperCase();}}catch(e){sourceSymbol=null;}// If the message is not for the currently-initialized symbol, ignore it.\nif(currentSymbolRef.current&&sourceSymbol){if(currentSymbolRef.current.toString().toUpperCase()!==sourceSymbol.toString().toUpperCase()){return;// ignore messages from other symbols\n}}// aggTrade messages have event type 'aggTrade' and price in p\nif(debug){try{const streamName=payloadWrapper.stream||payload.e||'unknown';console.log('[useEmaCross] incoming',{stream:streamName,sourceSymbol,event:payload.e||null});}catch(e){}}if(payload.e==='aggTrade'){const price=parseFloat(payload.p);// update live tick price only; do NOT overwrite the last closed price\n// which should be used for confirmed alerts.\nsetLastTick(price);if(ema9Ref.current==null||ema26Ref.current==null)return;// update EMA using trade price to provide higher-frequency preview\nconst newEma9=updateEMA(ema9Ref.current,price,26);const newEma26=updateEMA(ema26Ref.current,price,200);// preview EMAs only\nema9Ref.current=newEma9;ema26Ref.current=newEma26;setEma9(newEma9);setEma26(newEma26);// Do not update `cross` from trade ticks — keep cross decision tied to closed candles.\n}// kline messages contain a 'k' object\nif(payload.k){if(debug)console.log('[useEmaCross] kline payload x=',payload.k.x,'close=',payload.k.c);console.log('[useEmaCross] incoming kline',{stream:payloadWrapper.stream,currentSymbol:currentSymbolRef.current,lastProcessedClose:lastProcessedCloseRef.current});const k=payload.k;const close=parseFloat(k.c);// for partial candles, update live tick display; for closed candles\n// update the confirmed lastPrice (closed price) which will be used\n// for confirmedCross/notifications.\nsetLastTick(close);setLastCandleClosed(Boolean(k.x));if(ema9Ref.current==null||ema26Ref.current==null)return;// update EMA using kline close\n// For partial candle: update preview EMA only\nif(!k.x){const newEma9=updateEMA(ema9Ref.current,close,26);const newEma26=updateEMA(ema26Ref.current,close,200);ema9Ref.current=newEma9;ema26Ref.current=newEma26;setEma9(newEma9);setEma26(newEma26);}else{// closed candle: update confirmed EMAs only (and sync preview to confirmed)\nif(ema9ConfirmedRef.current==null||ema26ConfirmedRef.current==null){// defensive: fall back to preview if confirmed not initialized\nema9ConfirmedRef.current=ema9Ref.current;ema26ConfirmedRef.current=ema26Ref.current;}const newEma9c=updateEMA(ema9ConfirmedRef.current,close,26);const newEma26c=updateEMA(ema26ConfirmedRef.current,close,200);ema9ConfirmedRef.current=newEma9c;ema26ConfirmedRef.current=newEma26c;// sync preview to confirmed after closed candle to avoid drift\nema9Ref.current=newEma9c;ema26Ref.current=newEma26c;setEma9(newEma9c);setEma26(newEma26c);// closed candle: also record the closed price as the authoritative lastPrice\nsetLastPrice(close);}// Do not update `cross` for preview/partial candles here; cross will be\n// determined and updated only when a candle is closed (confirmed).\n// If candle is closed (k.x === true) and it's a new closed candle, update processed time and set confirmed cross\nif(Boolean(k.x)){try{const closeTime=k.T||k.t||null;// k.T is close time in ms\nconsole.log('[useEmaCross] closed kline closeTime=',closeTime,'lastProcessed=',lastProcessedCloseRef.current);// Process the closed kline when its closeTime is different from the last processed\n// one. Tests may send synthetic close times so use inequality instead of strict greater-than.\nif(closeTime&&closeTime!==lastProcessedCloseRef.current){lastProcessedCloseRef.current=closeTime;// compute confirmed cross using confirmed EMA refs (fallback to preview values)\nconst confirmedNewCross=ema9ConfirmedRef.current!=null&&ema26ConfirmedRef.current!=null?ema9ConfirmedRef.current>ema26ConfirmedRef.current?'bull':'bear':ema9Ref.current!=null&&ema26Ref.current!=null?ema9Ref.current>ema26Ref.current?'bull':'bear':null;// mark that a closed-candle was processed from the websocket\nsetConfirmedSource('ws');console.log('[useEmaCross] processed closed kline, confirmedSource set to ws, confirmedNewCross=',confirmedNewCross);if(prevConfirmedRef.current!==confirmedNewCross){prevConfirmedRef.current=confirmedNewCross;setConfirmedCross(confirmedNewCross);// also update public `cross` so UI reflects the closed-candle decision\nif(prevCrossRef.current!==confirmedNewCross){prevCrossRef.current=confirmedNewCross;setCross(confirmedNewCross);}}}}catch(e){// fallback: if we couldn't compute confirmed EMAs, fall back to\n// preview EMAs (if available) to set a confirmed-like value.\nconst fallback=ema9Ref.current!=null&&ema26Ref.current!=null?ema9Ref.current>ema26Ref.current?'bull':'bear':null;if(fallback&&prevConfirmedRef.current!==fallback){prevConfirmedRef.current=fallback;setConfirmedCross(fallback);setConfirmedSource('ws');console.log('[useEmaCross] fallback set confirmedSource=ws fallback=',fallback);}}}else{// partial candle: preview already updated above\n}}}catch(err){console.error('ws message parse error',err);}};ws.onerror=e=>{// if this socket was intentionally replaced by a new one, ignore errors\nif(ws.__replaced){if(debug)console.log('[useEmaCross] ignored error on replaced socket');return;}console.error('ws error',e);setStatus('websocket error');// close to trigger backoff reconnect\ntry{ws.close();}catch(err){}};ws.onclose=()=>{// if this socket was intentionally replaced by a new one, skip close handling\nif(ws.__replaced){if(debug)console.log('[useEmaCross] websocket was replaced; skipping onclose handling');return;}// Only mark disconnected if the socket closing is still the active socket.\n// Also, if we're in a replacement sequence, suppress transient disconnects.\nif(!replacementInProgressRef.current&&wsRef.current===ws){setConnected(false);}setStatus('websocket closed');wsRef.current=null;if(debug)console.log('[useEmaCross] websocket closed');// capture intended reconnect target now (before we nullify refs)\nconst reconnectTarget=currentSymbolRef.current||symbol;// clear active symbol immediately for UI, but keep reconnectTarget for retries\nsetActiveSymbol(null);// start polling for closed candles while websocket is down\ntry{if(!pollingTimerRef.current){pollingTimerRef.current=setInterval(async()=>{try{const sym=(reconnectTarget||symbol||'').replace(/[^A-Za-z0-9]/g,'').toUpperCase();if(!sym)return;const url=\"https://fapi.binance.com/fapi/v1/klines?symbol=\".concat(sym,\"&interval=5m&limit=10\");const res=await fetch(url);if(!res.ok)return;const data=await res.json();// iterate candles in chronological order and process any closed candles newer than lastProcessedCloseRef\nconst newClosed=[];for(const k of data){const closeTime=k[6];if(closeTime&&(!lastProcessedCloseRef.current||closeTime>lastProcessedCloseRef.current)){newClosed.push(k);}}if(newClosed.length>0){// sort by closeTime asc\nnewClosed.sort((a,b)=>a[6]-b[6]);for(const k of newClosed){const close=parseFloat(k[4]);// update EMAs using closed candle\nif(ema9Ref.current==null||ema26Ref.current==null)continue;// update confirmed EMAs using closed candle (polling)\nif(ema9ConfirmedRef.current==null||ema26ConfirmedRef.current==null){ema9ConfirmedRef.current=ema9Ref.current;ema26ConfirmedRef.current=ema26Ref.current;}const newEma9c=updateEMA(ema9ConfirmedRef.current,close,26);const newEma26c=updateEMA(ema26ConfirmedRef.current,close,200);ema9ConfirmedRef.current=newEma9c;ema26ConfirmedRef.current=newEma26c;// sync preview to confirmed\nema9Ref.current=newEma9c;ema26Ref.current=newEma26c;setEma9(newEma9c);setEma26(newEma26c);const newCross=newEma9c>newEma26c?'bull':'bear';if(prevConfirmedRef.current!==newCross){prevConfirmedRef.current=newCross;setConfirmedCross(newCross);setConfirmedSource('poll');}lastProcessedCloseRef.current=k[6];// polling provides closed-candle prices, so update authoritative lastPrice\nsetLastPrice(parseFloat(k[4]));setLastCandleClosed(true);}}}catch(e){// ignore polling errors\n}},10*1000);// poll every 10s\n}}catch(e){}// exponential backoff reconnect with jitter\nconst attempt=reconnectAttemptsRef.current||0;const base=1000;// 1s\nconst delay=Math.min(30000,base*Math.pow(2,attempt));const jitter=Math.floor(Math.random()*1000);reconnectAttemptsRef.current=attempt+1;reconnectTimerRef.current=setTimeout(()=>{reconnectTimerRef.current=null;if(!wsRef.current){// prefer reconnecting to the captured target\nconst target=reconnectTarget||symbol;try{connect(target);}catch(e){connect(target);}}},delay+jitter);// finally clear the currentSymbolRef to reflect that socket is closed\ncurrentSymbolRef.current=null;};},[symbol,fetchAndInit,debug]);const disconnect=useCallback(()=>{if(wsRef.current){wsRef.current.close();wsRef.current=null;}setConnected(false);setStatus('disconnected');setActiveSymbol(null);if(pollingTimerRef.current){clearInterval(pollingTimerRef.current);pollingTimerRef.current=null;}// clear reconnect attempts/timers\ntry{reconnectAttemptsRef.current=0;if(reconnectTimerRef.current){clearTimeout(reconnectTimerRef.current);reconnectTimerRef.current=null;}}catch(e){}},[]);useEffect(()=>{// initialize on mount (or when symbol changes)\n// Reset EMA/cross state for the new symbol, but do NOT forcibly close the existing websocket\n// to avoid a visible disconnect during a symbol switch. We keep the socket open until the\n// new connection is established by `connect` (which will replace the old socket).\ntry{// clear reconnect timers and attempts\nif(reconnectTimerRef.current){clearTimeout(reconnectTimerRef.current);reconnectTimerRef.current=null;}reconnectAttemptsRef.current=0;// reset refs and state for EMA and cross (prepare for new seed)\nprevCrossRef.current=null;currentSymbolRef.current=null;ema9Ref.current=null;ema26Ref.current=null;setEma9(null);setEma26(null);setLastPrice(null);setCross(null);setLastCandleClosed(false);// Set status to reloading while we fetch/init for the new symbol; do NOT set connected=false here,\n// so the UI remains 'connected' until the replacement socket opens (smoother UX).\nsetStatus('reloading');}catch(e){}// fetch history for the (new) symbol and initialize\nfetchAndInit();// cleanup on unmount\nreturn()=>{if(wsRef.current)wsRef.current.close();if(pollingTimerRef.current){clearInterval(pollingTimerRef.current);pollingTimerRef.current=null;}};},[fetchAndInit]);// auto connect after initialization if requested\nuseEffect(()=>{if(status==='initialized'&&autoConnect){// call connect once after initialization\nconnect();}// only run when status or autoConnect changes\n},[status,autoConnect,connect]);return{ema9,ema26,lastPrice,lastTick,lastCandleClosed,cross,confirmedCross,confirmedSource,connected,status,connect,disconnect,activeSymbol};}","map":{"version":3,"names":["useEffect","useRef","useState","useCallback","calculateInitialEMA","updateEMA","useEmaCross","symbol","autoConnect","debug","arguments","length","undefined","ema9","setEma9","ema26","setEma26","lastPrice","setLastPrice","lastTick","setLastTick","console","e","cross","setCross","confirmedCross","setConfirmedCross","confirmedSource","setConfirmedSource","connected","setConnected","status","setStatus","lastCandleClosed","setLastCandleClosed","activeSymbol","setActiveSymbol","wsRef","prevCrossRef","prevConfirmedRef","ema9Ref","ema26Ref","ema9ConfirmedRef","ema26ConfirmedRef","reconnectAttemptsRef","reconnectTimerRef","currentSymbolRef","lastProcessedCloseRef","pollingTimerRef","replacementInProgressRef","fetchAndInit","target","t","toString","norm","replace","toUpperCase","url","concat","res","fetch","ok","Error","data","json","closes","map","k","parseFloat","shortPeriod","longPeriod","seedShort","Math","min","seedLong","initEma9","initEma26","current","initialCross","err","message","error","connect","overrideSymbol","targetSymbol","targetNorm","klineStream","toLowerCase","tradeStream","streams","log","ws","WebSocket","oldWs","onopen","clearTimeout","clearInterval","__replaced","close","onmessage","ev","payloadWrapper","JSON","parse","payload","sourceSymbol","s","stream","streamName","split","event","price","p","newEma9","newEma26","x","c","currentSymbol","lastProcessedClose","Boolean","newEma9c","newEma26c","closeTime","T","confirmedNewCross","fallback","onerror","onclose","reconnectTarget","setInterval","sym","newClosed","push","sort","a","b","newCross","attempt","base","delay","pow","jitter","floor","random","setTimeout","disconnect"],"sources":["C:/Users/e1it3/Desktop/program/binance_alert/src/hooks/useEmaCross.js"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { calculateInitialEMA, updateEMA } from '../utils/ema';\r\n\r\n// Hook options: { symbol }\r\nexport default function useEmaCross({ symbol = 'BTCUSDT', autoConnect = true, debug = false } = {}) {\r\n  const [ema9, setEma9] = useState(null);\r\n  const [ema26, setEma26] = useState(null);\r\n  const [lastPrice, setLastPrice] = useState(null);\r\n  // lastTick represents the most recent trade/partial-candle price (live preview).\r\n  // lastPrice remains reserved for the most recent CLOSED candle price and is\r\n  // used when emitting confirmed alerts/notifications.\r\n  // eslint-disable-next-line no-unused-vars\r\n  const [lastTick, setLastTick] = useState(null);\r\n\r\n  // when debug is enabled, log lastTick updates so the variable is visibly used\r\n  // inside this module (and also helpful for debugging live preview values).\r\n  useEffect(() => {\r\n    try {\r\n      if (debug && typeof lastTick !== 'undefined' && lastTick !== null) {\r\n        // lightweight debug output\r\n        // eslint-disable-next-line no-console\r\n        console.debug('[useEmaCross] lastTick', lastTick);\r\n      }\r\n    } catch (e) {}\r\n  }, [lastTick, debug]);\r\n  const [cross, setCross] = useState(null); // preview (live) cross\r\n  const [confirmedCross, setConfirmedCross] = useState(null); // only updated on closed candles (confirmed)\r\n  const [confirmedSource, setConfirmedSource] = useState(null); // 'ws' | 'poll' | 'init'\r\n  const [connected, setConnected] = useState(false);\r\n  const [status, setStatus] = useState('idle');\r\n  const [lastCandleClosed, setLastCandleClosed] = useState(false);\r\n  const [activeSymbol, setActiveSymbol] = useState(null); // which symbol the hook has initialized/connected for\r\n\r\n  const wsRef = useRef(null);\r\n  const prevCrossRef = useRef(null);\r\n  const prevConfirmedRef = useRef(null);\r\n  const ema9Ref = useRef(null);\r\n  const ema26Ref = useRef(null);\r\n  // confirmed EMAs updated only on closed candles (kline.x === true) or polling\r\n  const ema9ConfirmedRef = useRef(null);\r\n  const ema26ConfirmedRef = useRef(null);\r\n  const reconnectAttemptsRef = useRef(0);\r\n  const reconnectTimerRef = useRef(null);\r\n  const currentSymbolRef = useRef(null);\r\n  const lastProcessedCloseRef = useRef(null); // timestamp (ms) of last processed closed candle\r\n  const pollingTimerRef = useRef(null);\r\n  const replacementInProgressRef = useRef(false);\r\n\r\n  const fetchAndInit = useCallback(async (target = symbol) => {\r\n    try {\r\n      const t = (target || symbol).toString();\r\n      setStatus('fetching historical klines');\r\n      const norm = t.replace(/[^A-Za-z0-9]/g, '').toUpperCase();\r\n  // use Binance Futures (USDT-M) REST endpoint for klines (5m)\r\n  const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${norm}&interval=5m&limit=500`;\r\n      const res = await fetch(url);\r\n      if (!res.ok) throw new Error(`Failed to fetch klines: ${res.status}`);\r\n      const data = await res.json();\r\n    // kline array: [ openTime, open, high, low, close, ... ]\r\n  const closes = data.map((k) => parseFloat(k[4]));\r\n\r\n  // Allow initializing EMAs with shorter history in tests or when full\r\n  // long-period history isn't available. Use the available history length\r\n  // as the seed period when it's smaller than the configured EMA period.\r\n  const shortPeriod = 26; // short EMA (26)\r\n  const longPeriod = 200; // long EMA (200)\r\n  const seedShort = Math.min(closes.length, shortPeriod);\r\n  const seedLong = Math.min(closes.length, longPeriod);\r\n  const initEma9 = calculateInitialEMA(closes, seedShort);\r\n  const initEma26 = calculateInitialEMA(closes, seedLong);\r\n\r\n    // initialize both preview and confirmed EMAs from historical closes\r\n    ema9Ref.current = initEma9;\r\n    ema26Ref.current = initEma26;\r\n    ema9ConfirmedRef.current = initEma9;\r\n    ema26ConfirmedRef.current = initEma26;\r\n      // record which symbol these EMAs correspond to\r\n      currentSymbolRef.current = norm;\r\n      setActiveSymbol(norm);\r\n      // record last processed closed candle time (closeTime at index 6)\r\n      try { lastProcessedCloseRef.current = data[data.length - 1][6]; } catch (e) { lastProcessedCloseRef.current = null; }\r\n    setEma9(initEma9);\r\n    setEma26(initEma26);\r\n    setLastPrice(closes[closes.length - 1]);\r\n      // indicate initialized\r\n      setStatus('initialized');\r\n  // mark that initial seeding completed; tests expect an 'init' source\r\n  setConfirmedSource('init');\r\n      // debug trace for tests\r\n      try { if (debug) console.debug('[useEmaCross] fetchAndInit completed for', norm, 'closes=', closes.length); } catch (e) {}\r\n      // set initial cross\r\n    const initialCross = initEma9 > initEma26 ? 'bull' : 'bear';\r\n      prevCrossRef.current = initialCross;\r\n  setCross(initialCross);\r\n  prevConfirmedRef.current = initialCross;\r\n  setConfirmedCross(initialCross);\r\n  setConfirmedSource('init');\r\n    } catch (err) {\r\n      setStatus(`init error: ${err.message}`);\r\n      console.error(err);\r\n    }\r\n  }, [symbol, debug]);\r\n\r\n  const connect = useCallback(async (overrideSymbol) => {\r\n    const targetSymbol = (overrideSymbol || symbol).toString();\r\n    const targetNorm = targetSymbol.replace(/[^A-Za-z0-9]/g, '').toUpperCase();\r\n    // if a websocket exists for same symbol, no-op\r\n    if (wsRef.current) {\r\n      if (currentSymbolRef.current === targetNorm) return;\r\n      // do NOT close the existing socket here; create a new socket and let the\r\n      // new socket's onopen handler replace/close the old socket to avoid a\r\n      // brief disconnected state in the UI.\r\n    }\r\n    // Ensure EMA is initialized for the target symbol before connecting\r\n    try {\r\n      const targetNorm = targetSymbol.replace(/[^A-Za-z0-9]/g, '').toUpperCase();\r\n      if (currentSymbolRef.current !== targetNorm || ema9Ref.current == null || ema26Ref.current == null) {\r\n        await fetchAndInit(targetNorm);\r\n      }\r\n    } catch (err) {\r\n      setStatus(`init error: ${err.message}`);\r\n      return;\r\n    }\r\n\r\n    setStatus('connecting websocket');\r\n    // Use combined stream: kline_5m + aggTrade for higher-frequency trade updates\r\n  const klineStream = `${targetNorm.toLowerCase()}@kline_5m`;\r\n  const tradeStream = `${targetNorm.toLowerCase()}@aggTrade`;\r\n    const streams = `${klineStream}/${tradeStream}`;\r\n  // use Binance Futures (USDT-M) websocket (fstream) combined stream\r\n  const url = `wss://fstream.binance.com/stream?streams=${streams}`;\r\n  console.log('Connecting websocket for', targetSymbol, 'url=', url);\r\n  const ws = new WebSocket(url);\r\n    // mark that we're starting a replacement sequence so temporary closes\r\n    // of the old socket don't flip the connected flag in the UI\r\n    replacementInProgressRef.current = true;\r\n    // Keep the UI connected while replacing sockets to avoid a brief disconnect\r\n    // state during symbol switches. We'll set the definitive connected state\r\n    // on the socket's onopen/onclose handlers.\r\n    try { setConnected(true); } catch (e) {}\r\n    // Do not overwrite wsRef.current immediately. Create a new socket and only replace the\r\n    // existing one after the new socket successfully opens. This allows a seamless symbol\r\n    // switch without briefly showing disconnected state in the UI.\r\n  const oldWs = wsRef.current;\r\n\r\n    ws.onopen = () => {\r\n      // mark as successful open\r\n      reconnectAttemptsRef.current = 0;\r\n      if (reconnectTimerRef.current) {\r\n        clearTimeout(reconnectTimerRef.current);\r\n        reconnectTimerRef.current = null;\r\n      }\r\n      // stop polling if it was started while socket was down\r\n      if (pollingTimerRef.current) {\r\n        clearInterval(pollingTimerRef.current);\r\n        pollingTimerRef.current = null;\r\n      }\r\n\r\n      // If there was a previous socket, mark it as replaced so its onclose handler\r\n      // skips reconnect logic, then close it.\r\n      try {\r\n        if (oldWs) {\r\n          oldWs.__replaced = true;\r\n          try { oldWs.close(); } catch (e) {}\r\n        }\r\n      } catch (e) {}\r\n\r\n      // replacement finished\r\n      replacementInProgressRef.current = false;\r\n\r\n      // now adopt the new socket as the active socket\r\n      wsRef.current = ws;\r\n      currentSymbolRef.current = targetNorm;\r\n      setActiveSymbol(targetNorm);\r\n    if (debug) console.log('[useEmaCross] websocket open for', targetNorm);\r\n  console.log('[useEmaCross] websocket onopen for', targetNorm, 'oldWs?', !!oldWs);\r\n  setConnected(true);\r\n  setStatus('connected');\r\n    };\r\n\r\n    ws.onmessage = (ev) => {\r\n      try {\r\n        const payloadWrapper = JSON.parse(ev.data);\r\n        // combined stream returns { stream, data }\r\n        const payload = payloadWrapper.data || payloadWrapper;\r\n\r\n        // determine the source symbol for this message (if available)\r\n        let sourceSymbol = null;\r\n        try {\r\n          if (payload && payload.s) sourceSymbol = payload.s.toString().toUpperCase();\r\n          else if (payloadWrapper && payloadWrapper.stream) {\r\n            const streamName = payloadWrapper.stream.toString(); // e.g. trxusdt@aggTrade\r\n            sourceSymbol = streamName.split('@')[0].toUpperCase();\r\n          }\r\n        } catch (e) { sourceSymbol = null; }\r\n\r\n        // If the message is not for the currently-initialized symbol, ignore it.\r\n        if (currentSymbolRef.current && sourceSymbol) {\r\n            if (currentSymbolRef.current.toString().toUpperCase() !== sourceSymbol.toString().toUpperCase()) {\r\n            return; // ignore messages from other symbols\r\n          }\r\n        }\r\n\r\n        // aggTrade messages have event type 'aggTrade' and price in p\r\n        if (debug) {\r\n          try {\r\n            const streamName = payloadWrapper.stream || payload.e || 'unknown';\r\n            console.log('[useEmaCross] incoming', { stream: streamName, sourceSymbol, event: payload.e || null });\r\n          } catch (e) {}\r\n        }\r\n        if (payload.e === 'aggTrade') {\r\n          const price = parseFloat(payload.p);\r\n          // update live tick price only; do NOT overwrite the last closed price\r\n          // which should be used for confirmed alerts.\r\n          setLastTick(price);\r\n\r\n          if (ema9Ref.current == null || ema26Ref.current == null) return;\r\n\r\n          // update EMA using trade price to provide higher-frequency preview\r\n          const newEma9 = updateEMA(ema9Ref.current, price, 26);\r\n          const newEma26 = updateEMA(ema26Ref.current, price, 200);\r\n          // preview EMAs only\r\n          ema9Ref.current = newEma9;\r\n          ema26Ref.current = newEma26;\r\n          setEma9(newEma9);\r\n          setEma26(newEma26);\r\n\r\n          // Do not update `cross` from trade ticks — keep cross decision tied to closed candles.\r\n        }\r\n\r\n        // kline messages contain a 'k' object\r\n        if (payload.k) {\r\n          if (debug) console.log('[useEmaCross] kline payload x=', payload.k.x, 'close=', payload.k.c);\r\n          console.log('[useEmaCross] incoming kline', { stream: payloadWrapper.stream, currentSymbol: currentSymbolRef.current, lastProcessedClose: lastProcessedCloseRef.current });\r\n          const k = payload.k;\r\n          const close = parseFloat(k.c);\r\n          // for partial candles, update live tick display; for closed candles\r\n          // update the confirmed lastPrice (closed price) which will be used\r\n          // for confirmedCross/notifications.\r\n          setLastTick(close);\r\n          setLastCandleClosed(Boolean(k.x));\r\n\r\n          if (ema9Ref.current == null || ema26Ref.current == null) return;\r\n\r\n          // update EMA using kline close\r\n          // For partial candle: update preview EMA only\r\n          if (!k.x) {\r\n            const newEma9 = updateEMA(ema9Ref.current, close, 26);\r\n            const newEma26 = updateEMA(ema26Ref.current, close, 200);\r\n            ema9Ref.current = newEma9;\r\n            ema26Ref.current = newEma26;\r\n            setEma9(newEma9);\r\n            setEma26(newEma26);\r\n            } else {\r\n            // closed candle: update confirmed EMAs only (and sync preview to confirmed)\r\n            if (ema9ConfirmedRef.current == null || ema26ConfirmedRef.current == null) {\r\n              // defensive: fall back to preview if confirmed not initialized\r\n              ema9ConfirmedRef.current = ema9Ref.current;\r\n              ema26ConfirmedRef.current = ema26Ref.current;\r\n            }\r\n            const newEma9c = updateEMA(ema9ConfirmedRef.current, close, 26);\r\n            const newEma26c = updateEMA(ema26ConfirmedRef.current, close, 200);\r\n            ema9ConfirmedRef.current = newEma9c;\r\n            ema26ConfirmedRef.current = newEma26c;\r\n            // sync preview to confirmed after closed candle to avoid drift\r\n            ema9Ref.current = newEma9c;\r\n            ema26Ref.current = newEma26c;\r\n            setEma9(newEma9c);\r\n            setEma26(newEma26c);\r\n            // closed candle: also record the closed price as the authoritative lastPrice\r\n            setLastPrice(close);\r\n          }\r\n\r\n          // Do not update `cross` for preview/partial candles here; cross will be\r\n          // determined and updated only when a candle is closed (confirmed).\r\n          // If candle is closed (k.x === true) and it's a new closed candle, update processed time and set confirmed cross\r\n          if (Boolean(k.x)) {\r\n            try {\r\n              const closeTime = k.T || k.t || null; // k.T is close time in ms\r\n              console.log('[useEmaCross] closed kline closeTime=', closeTime, 'lastProcessed=', lastProcessedCloseRef.current);\r\n              // Process the closed kline when its closeTime is different from the last processed\r\n              // one. Tests may send synthetic close times so use inequality instead of strict greater-than.\r\n              if (closeTime && closeTime !== lastProcessedCloseRef.current) {\r\n                lastProcessedCloseRef.current = closeTime;\r\n                // compute confirmed cross using confirmed EMA refs (fallback to preview values)\r\n                const confirmedNewCross = (ema9ConfirmedRef.current != null && ema26ConfirmedRef.current != null)\r\n                  ? (ema9ConfirmedRef.current > ema26ConfirmedRef.current ? 'bull' : 'bear')\r\n                  : ((ema9Ref.current != null && ema26Ref.current != null) ? (ema9Ref.current > ema26Ref.current ? 'bull' : 'bear') : null);\r\n                // mark that a closed-candle was processed from the websocket\r\n                setConfirmedSource('ws');\r\n                console.log('[useEmaCross] processed closed kline, confirmedSource set to ws, confirmedNewCross=', confirmedNewCross);\r\n                if (prevConfirmedRef.current !== confirmedNewCross) {\r\n                  prevConfirmedRef.current = confirmedNewCross;\r\n                  setConfirmedCross(confirmedNewCross);\r\n                  // also update public `cross` so UI reflects the closed-candle decision\r\n                  if (prevCrossRef.current !== confirmedNewCross) {\r\n                    prevCrossRef.current = confirmedNewCross;\r\n                    setCross(confirmedNewCross);\r\n                  }\r\n                }\r\n              }\r\n              } catch (e) {\r\n              // fallback: if we couldn't compute confirmed EMAs, fall back to\r\n              // preview EMAs (if available) to set a confirmed-like value.\r\n              const fallback = (ema9Ref.current != null && ema26Ref.current != null) ? (ema9Ref.current > ema26Ref.current ? 'bull' : 'bear') : null;\r\n              if (fallback && prevConfirmedRef.current !== fallback) {\r\n                prevConfirmedRef.current = fallback;\r\n                setConfirmedCross(fallback);\r\n                setConfirmedSource('ws');\r\n                console.log('[useEmaCross] fallback set confirmedSource=ws fallback=', fallback);\r\n              }\r\n            }\r\n          } else {\r\n            // partial candle: preview already updated above\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('ws message parse error', err);\r\n      }\r\n    };\r\n\r\n    ws.onerror = (e) => {\r\n      // if this socket was intentionally replaced by a new one, ignore errors\r\n      if (ws.__replaced) {\r\n        if (debug) console.log('[useEmaCross] ignored error on replaced socket');\r\n        return;\r\n      }\r\n      console.error('ws error', e);\r\n      setStatus('websocket error');\r\n      // close to trigger backoff reconnect\r\n      try { ws.close(); } catch (err) {}\r\n    };\r\n\r\n    ws.onclose = () => {\r\n      // if this socket was intentionally replaced by a new one, skip close handling\r\n      if (ws.__replaced) {\r\n        if (debug) console.log('[useEmaCross] websocket was replaced; skipping onclose handling');\r\n        return;\r\n      }\r\n      // Only mark disconnected if the socket closing is still the active socket.\r\n      // Also, if we're in a replacement sequence, suppress transient disconnects.\r\n      if (!replacementInProgressRef.current && wsRef.current === ws) {\r\n        setConnected(false);\r\n      }\r\n      setStatus('websocket closed');\r\n      wsRef.current = null;\r\n      if (debug) console.log('[useEmaCross] websocket closed');\r\n\r\n      // capture intended reconnect target now (before we nullify refs)\r\n      const reconnectTarget = currentSymbolRef.current || symbol;\r\n      // clear active symbol immediately for UI, but keep reconnectTarget for retries\r\n      setActiveSymbol(null);\r\n\r\n      // start polling for closed candles while websocket is down\r\n      try {\r\n        if (!pollingTimerRef.current) {\r\n          pollingTimerRef.current = setInterval(async () => {\r\n            try {\r\n              const sym = (reconnectTarget || symbol || '').replace(/[^A-Za-z0-9]/g, '').toUpperCase();\r\n              if (!sym) return;\r\n              const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=5m&limit=10`;\r\n              const res = await fetch(url);\r\n              if (!res.ok) return;\r\n              const data = await res.json();\r\n              // iterate candles in chronological order and process any closed candles newer than lastProcessedCloseRef\r\n              const newClosed = [];\r\n              for (const k of data) {\r\n                const closeTime = k[6];\r\n                if (closeTime && (!lastProcessedCloseRef.current || closeTime > lastProcessedCloseRef.current)) {\r\n                  newClosed.push(k);\r\n                }\r\n              }\r\n              if (newClosed.length > 0) {\r\n                // sort by closeTime asc\r\n                newClosed.sort((a, b) => a[6] - b[6]);\r\n                for (const k of newClosed) {\r\n                  const close = parseFloat(k[4]);\r\n                  // update EMAs using closed candle\r\n                  if (ema9Ref.current == null || ema26Ref.current == null) continue;\r\n                  // update confirmed EMAs using closed candle (polling)\r\n                  if (ema9ConfirmedRef.current == null || ema26ConfirmedRef.current == null) {\r\n                    ema9ConfirmedRef.current = ema9Ref.current;\r\n                    ema26ConfirmedRef.current = ema26Ref.current;\r\n                  }\r\n                  const newEma9c = updateEMA(ema9ConfirmedRef.current, close, 26);\r\n                  const newEma26c = updateEMA(ema26ConfirmedRef.current, close, 200);\r\n                  ema9ConfirmedRef.current = newEma9c;\r\n                  ema26ConfirmedRef.current = newEma26c;\r\n                  // sync preview to confirmed\r\n                  ema9Ref.current = newEma9c;\r\n                  ema26Ref.current = newEma26c;\r\n                  setEma9(newEma9c);\r\n                  setEma26(newEma26c);\r\n                  const newCross = newEma9c > newEma26c ? 'bull' : 'bear';\r\n                  if (prevConfirmedRef.current !== newCross) {\r\n                    prevConfirmedRef.current = newCross;\r\n                    setConfirmedCross(newCross);\r\n                    setConfirmedSource('poll');\r\n                  }\r\n                  lastProcessedCloseRef.current = k[6];\r\n                  // polling provides closed-candle prices, so update authoritative lastPrice\r\n                  setLastPrice(parseFloat(k[4]));\r\n                  setLastCandleClosed(true);\r\n                }\r\n              }\r\n            } catch (e) {\r\n              // ignore polling errors\r\n            }\r\n          }, 10 * 1000); // poll every 10s\r\n        }\r\n      } catch (e) {}\r\n\r\n      // exponential backoff reconnect with jitter\r\n      const attempt = reconnectAttemptsRef.current || 0;\r\n      const base = 1000; // 1s\r\n      const delay = Math.min(30000, base * Math.pow(2, attempt));\r\n      const jitter = Math.floor(Math.random() * 1000);\r\n      reconnectAttemptsRef.current = attempt + 1;\r\n      reconnectTimerRef.current = setTimeout(() => {\r\n        reconnectTimerRef.current = null;\r\n        if (!wsRef.current) {\r\n          // prefer reconnecting to the captured target\r\n          const target = reconnectTarget || symbol;\r\n          try { connect(target); } catch (e) { connect(target); }\r\n        }\r\n      }, delay + jitter);\r\n\r\n      // finally clear the currentSymbolRef to reflect that socket is closed\r\n      currentSymbolRef.current = null;\r\n    };\r\n  }, [symbol, fetchAndInit, debug]);\r\n\r\n  const disconnect = useCallback(() => {\r\n    if (wsRef.current) {\r\n      wsRef.current.close();\r\n      wsRef.current = null;\r\n    }\r\n    setConnected(false);\r\n    setStatus('disconnected');\r\n    setActiveSymbol(null);\r\n    if (pollingTimerRef.current) {\r\n      clearInterval(pollingTimerRef.current);\r\n      pollingTimerRef.current = null;\r\n    }\r\n    // clear reconnect attempts/timers\r\n    try {\r\n      reconnectAttemptsRef.current = 0;\r\n      if (reconnectTimerRef.current) {\r\n        clearTimeout(reconnectTimerRef.current);\r\n        reconnectTimerRef.current = null;\r\n      }\r\n    } catch (e) {}\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // initialize on mount (or when symbol changes)\r\n    // Reset EMA/cross state for the new symbol, but do NOT forcibly close the existing websocket\r\n    // to avoid a visible disconnect during a symbol switch. We keep the socket open until the\r\n    // new connection is established by `connect` (which will replace the old socket).\r\n    try {\r\n      // clear reconnect timers and attempts\r\n      if (reconnectTimerRef.current) {\r\n        clearTimeout(reconnectTimerRef.current);\r\n        reconnectTimerRef.current = null;\r\n      }\r\n      reconnectAttemptsRef.current = 0;\r\n\r\n      // reset refs and state for EMA and cross (prepare for new seed)\r\n      prevCrossRef.current = null;\r\n      currentSymbolRef.current = null;\r\n      ema9Ref.current = null;\r\n      ema26Ref.current = null;\r\n      setEma9(null);\r\n      setEma26(null);\r\n      setLastPrice(null);\r\n      setCross(null);\r\n      setLastCandleClosed(false);\r\n      // Set status to reloading while we fetch/init for the new symbol; do NOT set connected=false here,\r\n      // so the UI remains 'connected' until the replacement socket opens (smoother UX).\r\n      setStatus('reloading');\r\n    } catch (e) {}\r\n    // fetch history for the (new) symbol and initialize\r\n    fetchAndInit();\r\n    // cleanup on unmount\r\n    return () => {\r\n      if (wsRef.current) wsRef.current.close();\r\n      if (pollingTimerRef.current) {\r\n        clearInterval(pollingTimerRef.current);\r\n        pollingTimerRef.current = null;\r\n      }\r\n    };\r\n  }, [fetchAndInit]);\r\n\r\n  // auto connect after initialization if requested\r\n  useEffect(() => {\r\n    if (status === 'initialized' && autoConnect) {\r\n      // call connect once after initialization\r\n      connect();\r\n    }\r\n    // only run when status or autoConnect changes\r\n  }, [status, autoConnect, connect]);\r\n\r\n  return {\r\n    ema9,\r\n    ema26,\r\n    lastPrice,\r\n    lastTick,\r\n    lastCandleClosed,\r\n    cross,\r\n    confirmedCross,\r\n    confirmedSource,\r\n    connected,\r\n    status,\r\n    connect,\r\n    disconnect,\r\n    activeSymbol,\r\n  };\r\n}\r\n"],"mappings":"AAAA,OAASA,SAAS,CAAEC,MAAM,CAAEC,QAAQ,CAAEC,WAAW,KAAQ,OAAO,CAChE,OAASC,mBAAmB,CAAEC,SAAS,KAAQ,cAAc,CAE7D;AACA,cAAe,SAAS,CAAAC,WAAWA,CAAA,CAAiE,IAAhE,CAAEC,MAAM,CAAG,SAAS,CAAEC,WAAW,CAAG,IAAI,CAAEC,KAAK,CAAG,KAAM,CAAC,CAAAC,SAAA,CAAAC,MAAA,IAAAD,SAAA,MAAAE,SAAA,CAAAF,SAAA,IAAG,CAAC,CAAC,CAChG,KAAM,CAACG,IAAI,CAAEC,OAAO,CAAC,CAAGZ,QAAQ,CAAC,IAAI,CAAC,CACtC,KAAM,CAACa,KAAK,CAAEC,QAAQ,CAAC,CAAGd,QAAQ,CAAC,IAAI,CAAC,CACxC,KAAM,CAACe,SAAS,CAAEC,YAAY,CAAC,CAAGhB,QAAQ,CAAC,IAAI,CAAC,CAChD;AACA;AACA;AACA;AACA,KAAM,CAACiB,QAAQ,CAAEC,WAAW,CAAC,CAAGlB,QAAQ,CAAC,IAAI,CAAC,CAE9C;AACA;AACAF,SAAS,CAAC,IAAM,CACd,GAAI,CACF,GAAIS,KAAK,EAAI,MAAO,CAAAU,QAAQ,GAAK,WAAW,EAAIA,QAAQ,GAAK,IAAI,CAAE,CACjE;AACA;AACAE,OAAO,CAACZ,KAAK,CAAC,wBAAwB,CAAEU,QAAQ,CAAC,CACnD,CACF,CAAE,MAAOG,CAAC,CAAE,CAAC,CACf,CAAC,CAAE,CAACH,QAAQ,CAAEV,KAAK,CAAC,CAAC,CACrB,KAAM,CAACc,KAAK,CAAEC,QAAQ,CAAC,CAAGtB,QAAQ,CAAC,IAAI,CAAC,CAAE;AAC1C,KAAM,CAACuB,cAAc,CAAEC,iBAAiB,CAAC,CAAGxB,QAAQ,CAAC,IAAI,CAAC,CAAE;AAC5D,KAAM,CAACyB,eAAe,CAAEC,kBAAkB,CAAC,CAAG1B,QAAQ,CAAC,IAAI,CAAC,CAAE;AAC9D,KAAM,CAAC2B,SAAS,CAAEC,YAAY,CAAC,CAAG5B,QAAQ,CAAC,KAAK,CAAC,CACjD,KAAM,CAAC6B,MAAM,CAAEC,SAAS,CAAC,CAAG9B,QAAQ,CAAC,MAAM,CAAC,CAC5C,KAAM,CAAC+B,gBAAgB,CAAEC,mBAAmB,CAAC,CAAGhC,QAAQ,CAAC,KAAK,CAAC,CAC/D,KAAM,CAACiC,YAAY,CAAEC,eAAe,CAAC,CAAGlC,QAAQ,CAAC,IAAI,CAAC,CAAE;AAExD,KAAM,CAAAmC,KAAK,CAAGpC,MAAM,CAAC,IAAI,CAAC,CAC1B,KAAM,CAAAqC,YAAY,CAAGrC,MAAM,CAAC,IAAI,CAAC,CACjC,KAAM,CAAAsC,gBAAgB,CAAGtC,MAAM,CAAC,IAAI,CAAC,CACrC,KAAM,CAAAuC,OAAO,CAAGvC,MAAM,CAAC,IAAI,CAAC,CAC5B,KAAM,CAAAwC,QAAQ,CAAGxC,MAAM,CAAC,IAAI,CAAC,CAC7B;AACA,KAAM,CAAAyC,gBAAgB,CAAGzC,MAAM,CAAC,IAAI,CAAC,CACrC,KAAM,CAAA0C,iBAAiB,CAAG1C,MAAM,CAAC,IAAI,CAAC,CACtC,KAAM,CAAA2C,oBAAoB,CAAG3C,MAAM,CAAC,CAAC,CAAC,CACtC,KAAM,CAAA4C,iBAAiB,CAAG5C,MAAM,CAAC,IAAI,CAAC,CACtC,KAAM,CAAA6C,gBAAgB,CAAG7C,MAAM,CAAC,IAAI,CAAC,CACrC,KAAM,CAAA8C,qBAAqB,CAAG9C,MAAM,CAAC,IAAI,CAAC,CAAE;AAC5C,KAAM,CAAA+C,eAAe,CAAG/C,MAAM,CAAC,IAAI,CAAC,CACpC,KAAM,CAAAgD,wBAAwB,CAAGhD,MAAM,CAAC,KAAK,CAAC,CAE9C,KAAM,CAAAiD,YAAY,CAAG/C,WAAW,CAAC,gBAA2B,IAApB,CAAAgD,MAAM,CAAAzC,SAAA,CAAAC,MAAA,IAAAD,SAAA,MAAAE,SAAA,CAAAF,SAAA,IAAGH,MAAM,CACrD,GAAI,CACF,KAAM,CAAA6C,CAAC,CAAG,CAACD,MAAM,EAAI5C,MAAM,EAAE8C,QAAQ,CAAC,CAAC,CACvCrB,SAAS,CAAC,4BAA4B,CAAC,CACvC,KAAM,CAAAsB,IAAI,CAAGF,CAAC,CAACG,OAAO,CAAC,eAAe,CAAE,EAAE,CAAC,CAACC,WAAW,CAAC,CAAC,CAC7D;AACA,KAAM,CAAAC,GAAG,mDAAAC,MAAA,CAAqDJ,IAAI,0BAAwB,CACtF,KAAM,CAAAK,GAAG,CAAG,KAAM,CAAAC,KAAK,CAACH,GAAG,CAAC,CAC5B,GAAI,CAACE,GAAG,CAACE,EAAE,CAAE,KAAM,IAAI,CAAAC,KAAK,4BAAAJ,MAAA,CAA4BC,GAAG,CAAC5B,MAAM,CAAE,CAAC,CACrE,KAAM,CAAAgC,IAAI,CAAG,KAAM,CAAAJ,GAAG,CAACK,IAAI,CAAC,CAAC,CAC/B;AACF,KAAM,CAAAC,MAAM,CAAGF,IAAI,CAACG,GAAG,CAAEC,CAAC,EAAKC,UAAU,CAACD,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAEhD;AACA;AACA;AACA,KAAM,CAAAE,WAAW,CAAG,EAAE,CAAE;AACxB,KAAM,CAAAC,UAAU,CAAG,GAAG,CAAE;AACxB,KAAM,CAAAC,SAAS,CAAGC,IAAI,CAACC,GAAG,CAACR,MAAM,CAACtD,MAAM,CAAE0D,WAAW,CAAC,CACtD,KAAM,CAAAK,QAAQ,CAAGF,IAAI,CAACC,GAAG,CAACR,MAAM,CAACtD,MAAM,CAAE2D,UAAU,CAAC,CACpD,KAAM,CAAAK,QAAQ,CAAGvE,mBAAmB,CAAC6D,MAAM,CAAEM,SAAS,CAAC,CACvD,KAAM,CAAAK,SAAS,CAAGxE,mBAAmB,CAAC6D,MAAM,CAAES,QAAQ,CAAC,CAErD;AACAlC,OAAO,CAACqC,OAAO,CAAGF,QAAQ,CAC1BlC,QAAQ,CAACoC,OAAO,CAAGD,SAAS,CAC5BlC,gBAAgB,CAACmC,OAAO,CAAGF,QAAQ,CACnChC,iBAAiB,CAACkC,OAAO,CAAGD,SAAS,CACnC;AACA9B,gBAAgB,CAAC+B,OAAO,CAAGvB,IAAI,CAC/BlB,eAAe,CAACkB,IAAI,CAAC,CACrB;AACA,GAAI,CAAEP,qBAAqB,CAAC8B,OAAO,CAAGd,IAAI,CAACA,IAAI,CAACpD,MAAM,CAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAE,CAAE,MAAOW,CAAC,CAAE,CAAEyB,qBAAqB,CAAC8B,OAAO,CAAG,IAAI,CAAE,CACtH/D,OAAO,CAAC6D,QAAQ,CAAC,CACjB3D,QAAQ,CAAC4D,SAAS,CAAC,CACnB1D,YAAY,CAAC+C,MAAM,CAACA,MAAM,CAACtD,MAAM,CAAG,CAAC,CAAC,CAAC,CACrC;AACAqB,SAAS,CAAC,aAAa,CAAC,CAC5B;AACAJ,kBAAkB,CAAC,MAAM,CAAC,CACtB;AACA,GAAI,CAAE,GAAInB,KAAK,CAAEY,OAAO,CAACZ,KAAK,CAAC,0CAA0C,CAAE6C,IAAI,CAAE,SAAS,CAAEW,MAAM,CAACtD,MAAM,CAAC,CAAE,CAAE,MAAOW,CAAC,CAAE,CAAC,CACzH;AACF,KAAM,CAAAwD,YAAY,CAAGH,QAAQ,CAAGC,SAAS,CAAG,MAAM,CAAG,MAAM,CACzDtC,YAAY,CAACuC,OAAO,CAAGC,YAAY,CACvCtD,QAAQ,CAACsD,YAAY,CAAC,CACtBvC,gBAAgB,CAACsC,OAAO,CAAGC,YAAY,CACvCpD,iBAAiB,CAACoD,YAAY,CAAC,CAC/BlD,kBAAkB,CAAC,MAAM,CAAC,CACxB,CAAE,MAAOmD,GAAG,CAAE,CACZ/C,SAAS,gBAAA0B,MAAA,CAAgBqB,GAAG,CAACC,OAAO,CAAE,CAAC,CACvC3D,OAAO,CAAC4D,KAAK,CAACF,GAAG,CAAC,CACpB,CACF,CAAC,CAAE,CAACxE,MAAM,CAAEE,KAAK,CAAC,CAAC,CAEnB,KAAM,CAAAyE,OAAO,CAAG/E,WAAW,CAAC,KAAO,CAAAgF,cAAc,EAAK,CACpD,KAAM,CAAAC,YAAY,CAAG,CAACD,cAAc,EAAI5E,MAAM,EAAE8C,QAAQ,CAAC,CAAC,CAC1D,KAAM,CAAAgC,UAAU,CAAGD,YAAY,CAAC7B,OAAO,CAAC,eAAe,CAAE,EAAE,CAAC,CAACC,WAAW,CAAC,CAAC,CAC1E;AACA,GAAInB,KAAK,CAACwC,OAAO,CAAE,CACjB,GAAI/B,gBAAgB,CAAC+B,OAAO,GAAKQ,UAAU,CAAE,OAC7C;AACA;AACA;AACF,CACA;AACA,GAAI,CACF,KAAM,CAAAA,UAAU,CAAGD,YAAY,CAAC7B,OAAO,CAAC,eAAe,CAAE,EAAE,CAAC,CAACC,WAAW,CAAC,CAAC,CAC1E,GAAIV,gBAAgB,CAAC+B,OAAO,GAAKQ,UAAU,EAAI7C,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAE,CAClG,KAAM,CAAA3B,YAAY,CAACmC,UAAU,CAAC,CAChC,CACF,CAAE,MAAON,GAAG,CAAE,CACZ/C,SAAS,gBAAA0B,MAAA,CAAgBqB,GAAG,CAACC,OAAO,CAAE,CAAC,CACvC,OACF,CAEAhD,SAAS,CAAC,sBAAsB,CAAC,CACjC;AACF,KAAM,CAAAsD,WAAW,IAAA5B,MAAA,CAAM2B,UAAU,CAACE,WAAW,CAAC,CAAC,aAAW,CAC1D,KAAM,CAAAC,WAAW,IAAA9B,MAAA,CAAM2B,UAAU,CAACE,WAAW,CAAC,CAAC,aAAW,CACxD,KAAM,CAAAE,OAAO,IAAA/B,MAAA,CAAM4B,WAAW,MAAA5B,MAAA,CAAI8B,WAAW,CAAE,CACjD;AACA,KAAM,CAAA/B,GAAG,6CAAAC,MAAA,CAA+C+B,OAAO,CAAE,CACjEpE,OAAO,CAACqE,GAAG,CAAC,0BAA0B,CAAEN,YAAY,CAAE,MAAM,CAAE3B,GAAG,CAAC,CAClE,KAAM,CAAAkC,EAAE,CAAG,GAAI,CAAAC,SAAS,CAACnC,GAAG,CAAC,CAC3B;AACA;AACAR,wBAAwB,CAAC4B,OAAO,CAAG,IAAI,CACvC;AACA;AACA;AACA,GAAI,CAAE/C,YAAY,CAAC,IAAI,CAAC,CAAE,CAAE,MAAOR,CAAC,CAAE,CAAC,CACvC;AACA;AACA;AACF,KAAM,CAAAuE,KAAK,CAAGxD,KAAK,CAACwC,OAAO,CAEzBc,EAAE,CAACG,MAAM,CAAG,IAAM,CAChB;AACAlD,oBAAoB,CAACiC,OAAO,CAAG,CAAC,CAChC,GAAIhC,iBAAiB,CAACgC,OAAO,CAAE,CAC7BkB,YAAY,CAAClD,iBAAiB,CAACgC,OAAO,CAAC,CACvChC,iBAAiB,CAACgC,OAAO,CAAG,IAAI,CAClC,CACA;AACA,GAAI7B,eAAe,CAAC6B,OAAO,CAAE,CAC3BmB,aAAa,CAAChD,eAAe,CAAC6B,OAAO,CAAC,CACtC7B,eAAe,CAAC6B,OAAO,CAAG,IAAI,CAChC,CAEA;AACA;AACA,GAAI,CACF,GAAIgB,KAAK,CAAE,CACTA,KAAK,CAACI,UAAU,CAAG,IAAI,CACvB,GAAI,CAAEJ,KAAK,CAACK,KAAK,CAAC,CAAC,CAAE,CAAE,MAAO5E,CAAC,CAAE,CAAC,CACpC,CACF,CAAE,MAAOA,CAAC,CAAE,CAAC,CAEb;AACA2B,wBAAwB,CAAC4B,OAAO,CAAG,KAAK,CAExC;AACAxC,KAAK,CAACwC,OAAO,CAAGc,EAAE,CAClB7C,gBAAgB,CAAC+B,OAAO,CAAGQ,UAAU,CACrCjD,eAAe,CAACiD,UAAU,CAAC,CAC7B,GAAI5E,KAAK,CAAEY,OAAO,CAACqE,GAAG,CAAC,kCAAkC,CAAEL,UAAU,CAAC,CACxEhE,OAAO,CAACqE,GAAG,CAAC,oCAAoC,CAAEL,UAAU,CAAE,QAAQ,CAAE,CAAC,CAACQ,KAAK,CAAC,CAChF/D,YAAY,CAAC,IAAI,CAAC,CAClBE,SAAS,CAAC,WAAW,CAAC,CACpB,CAAC,CAED2D,EAAE,CAACQ,SAAS,CAAIC,EAAE,EAAK,CACrB,GAAI,CACF,KAAM,CAAAC,cAAc,CAAGC,IAAI,CAACC,KAAK,CAACH,EAAE,CAACrC,IAAI,CAAC,CAC1C;AACA,KAAM,CAAAyC,OAAO,CAAGH,cAAc,CAACtC,IAAI,EAAIsC,cAAc,CAErD;AACA,GAAI,CAAAI,YAAY,CAAG,IAAI,CACvB,GAAI,CACF,GAAID,OAAO,EAAIA,OAAO,CAACE,CAAC,CAAED,YAAY,CAAGD,OAAO,CAACE,CAAC,CAACrD,QAAQ,CAAC,CAAC,CAACG,WAAW,CAAC,CAAC,CAAC,IACvE,IAAI6C,cAAc,EAAIA,cAAc,CAACM,MAAM,CAAE,CAChD,KAAM,CAAAC,UAAU,CAAGP,cAAc,CAACM,MAAM,CAACtD,QAAQ,CAAC,CAAC,CAAE;AACrDoD,YAAY,CAAGG,UAAU,CAACC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAACrD,WAAW,CAAC,CAAC,CACvD,CACF,CAAE,MAAOlC,CAAC,CAAE,CAAEmF,YAAY,CAAG,IAAI,CAAE,CAEnC;AACA,GAAI3D,gBAAgB,CAAC+B,OAAO,EAAI4B,YAAY,CAAE,CAC1C,GAAI3D,gBAAgB,CAAC+B,OAAO,CAACxB,QAAQ,CAAC,CAAC,CAACG,WAAW,CAAC,CAAC,GAAKiD,YAAY,CAACpD,QAAQ,CAAC,CAAC,CAACG,WAAW,CAAC,CAAC,CAAE,CACjG,OAAQ;AACV,CACF,CAEA;AACA,GAAI/C,KAAK,CAAE,CACT,GAAI,CACF,KAAM,CAAAmG,UAAU,CAAGP,cAAc,CAACM,MAAM,EAAIH,OAAO,CAAClF,CAAC,EAAI,SAAS,CAClED,OAAO,CAACqE,GAAG,CAAC,wBAAwB,CAAE,CAAEiB,MAAM,CAAEC,UAAU,CAAEH,YAAY,CAAEK,KAAK,CAAEN,OAAO,CAAClF,CAAC,EAAI,IAAK,CAAC,CAAC,CACvG,CAAE,MAAOA,CAAC,CAAE,CAAC,CACf,CACA,GAAIkF,OAAO,CAAClF,CAAC,GAAK,UAAU,CAAE,CAC5B,KAAM,CAAAyF,KAAK,CAAG3C,UAAU,CAACoC,OAAO,CAACQ,CAAC,CAAC,CACnC;AACA;AACA5F,WAAW,CAAC2F,KAAK,CAAC,CAElB,GAAIvE,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAE,OAEzD;AACA,KAAM,CAAAoC,OAAO,CAAG5G,SAAS,CAACmC,OAAO,CAACqC,OAAO,CAAEkC,KAAK,CAAE,EAAE,CAAC,CACrD,KAAM,CAAAG,QAAQ,CAAG7G,SAAS,CAACoC,QAAQ,CAACoC,OAAO,CAAEkC,KAAK,CAAE,GAAG,CAAC,CACxD;AACAvE,OAAO,CAACqC,OAAO,CAAGoC,OAAO,CACzBxE,QAAQ,CAACoC,OAAO,CAAGqC,QAAQ,CAC3BpG,OAAO,CAACmG,OAAO,CAAC,CAChBjG,QAAQ,CAACkG,QAAQ,CAAC,CAElB;AACF,CAEA;AACA,GAAIV,OAAO,CAACrC,CAAC,CAAE,CACb,GAAI1D,KAAK,CAAEY,OAAO,CAACqE,GAAG,CAAC,gCAAgC,CAAEc,OAAO,CAACrC,CAAC,CAACgD,CAAC,CAAE,QAAQ,CAAEX,OAAO,CAACrC,CAAC,CAACiD,CAAC,CAAC,CAC5F/F,OAAO,CAACqE,GAAG,CAAC,8BAA8B,CAAE,CAAEiB,MAAM,CAAEN,cAAc,CAACM,MAAM,CAAEU,aAAa,CAAEvE,gBAAgB,CAAC+B,OAAO,CAAEyC,kBAAkB,CAAEvE,qBAAqB,CAAC8B,OAAQ,CAAC,CAAC,CAC1K,KAAM,CAAAV,CAAC,CAAGqC,OAAO,CAACrC,CAAC,CACnB,KAAM,CAAA+B,KAAK,CAAG9B,UAAU,CAACD,CAAC,CAACiD,CAAC,CAAC,CAC7B;AACA;AACA;AACAhG,WAAW,CAAC8E,KAAK,CAAC,CAClBhE,mBAAmB,CAACqF,OAAO,CAACpD,CAAC,CAACgD,CAAC,CAAC,CAAC,CAEjC,GAAI3E,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAE,OAEzD;AACA;AACA,GAAI,CAACV,CAAC,CAACgD,CAAC,CAAE,CACR,KAAM,CAAAF,OAAO,CAAG5G,SAAS,CAACmC,OAAO,CAACqC,OAAO,CAAEqB,KAAK,CAAE,EAAE,CAAC,CACrD,KAAM,CAAAgB,QAAQ,CAAG7G,SAAS,CAACoC,QAAQ,CAACoC,OAAO,CAAEqB,KAAK,CAAE,GAAG,CAAC,CACxD1D,OAAO,CAACqC,OAAO,CAAGoC,OAAO,CACzBxE,QAAQ,CAACoC,OAAO,CAAGqC,QAAQ,CAC3BpG,OAAO,CAACmG,OAAO,CAAC,CAChBjG,QAAQ,CAACkG,QAAQ,CAAC,CAClB,CAAC,IAAM,CACP;AACA,GAAIxE,gBAAgB,CAACmC,OAAO,EAAI,IAAI,EAAIlC,iBAAiB,CAACkC,OAAO,EAAI,IAAI,CAAE,CACzE;AACAnC,gBAAgB,CAACmC,OAAO,CAAGrC,OAAO,CAACqC,OAAO,CAC1ClC,iBAAiB,CAACkC,OAAO,CAAGpC,QAAQ,CAACoC,OAAO,CAC9C,CACA,KAAM,CAAA2C,QAAQ,CAAGnH,SAAS,CAACqC,gBAAgB,CAACmC,OAAO,CAAEqB,KAAK,CAAE,EAAE,CAAC,CAC/D,KAAM,CAAAuB,SAAS,CAAGpH,SAAS,CAACsC,iBAAiB,CAACkC,OAAO,CAAEqB,KAAK,CAAE,GAAG,CAAC,CAClExD,gBAAgB,CAACmC,OAAO,CAAG2C,QAAQ,CACnC7E,iBAAiB,CAACkC,OAAO,CAAG4C,SAAS,CACrC;AACAjF,OAAO,CAACqC,OAAO,CAAG2C,QAAQ,CAC1B/E,QAAQ,CAACoC,OAAO,CAAG4C,SAAS,CAC5B3G,OAAO,CAAC0G,QAAQ,CAAC,CACjBxG,QAAQ,CAACyG,SAAS,CAAC,CACnB;AACAvG,YAAY,CAACgF,KAAK,CAAC,CACrB,CAEA;AACA;AACA;AACA,GAAIqB,OAAO,CAACpD,CAAC,CAACgD,CAAC,CAAC,CAAE,CAChB,GAAI,CACF,KAAM,CAAAO,SAAS,CAAGvD,CAAC,CAACwD,CAAC,EAAIxD,CAAC,CAACf,CAAC,EAAI,IAAI,CAAE;AACtC/B,OAAO,CAACqE,GAAG,CAAC,uCAAuC,CAAEgC,SAAS,CAAE,gBAAgB,CAAE3E,qBAAqB,CAAC8B,OAAO,CAAC,CAChH;AACA;AACA,GAAI6C,SAAS,EAAIA,SAAS,GAAK3E,qBAAqB,CAAC8B,OAAO,CAAE,CAC5D9B,qBAAqB,CAAC8B,OAAO,CAAG6C,SAAS,CACzC;AACA,KAAM,CAAAE,iBAAiB,CAAIlF,gBAAgB,CAACmC,OAAO,EAAI,IAAI,EAAIlC,iBAAiB,CAACkC,OAAO,EAAI,IAAI,CAC3FnC,gBAAgB,CAACmC,OAAO,CAAGlC,iBAAiB,CAACkC,OAAO,CAAG,MAAM,CAAG,MAAM,CACrErC,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAKrC,OAAO,CAACqC,OAAO,CAAGpC,QAAQ,CAACoC,OAAO,CAAG,MAAM,CAAG,MAAM,CAAI,IAAK,CAC3H;AACAjD,kBAAkB,CAAC,IAAI,CAAC,CACxBP,OAAO,CAACqE,GAAG,CAAC,qFAAqF,CAAEkC,iBAAiB,CAAC,CACrH,GAAIrF,gBAAgB,CAACsC,OAAO,GAAK+C,iBAAiB,CAAE,CAClDrF,gBAAgB,CAACsC,OAAO,CAAG+C,iBAAiB,CAC5ClG,iBAAiB,CAACkG,iBAAiB,CAAC,CACpC;AACA,GAAItF,YAAY,CAACuC,OAAO,GAAK+C,iBAAiB,CAAE,CAC9CtF,YAAY,CAACuC,OAAO,CAAG+C,iBAAiB,CACxCpG,QAAQ,CAACoG,iBAAiB,CAAC,CAC7B,CACF,CACF,CACA,CAAE,MAAOtG,CAAC,CAAE,CACZ;AACA;AACA,KAAM,CAAAuG,QAAQ,CAAIrF,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAKrC,OAAO,CAACqC,OAAO,CAAGpC,QAAQ,CAACoC,OAAO,CAAG,MAAM,CAAG,MAAM,CAAI,IAAI,CACtI,GAAIgD,QAAQ,EAAItF,gBAAgB,CAACsC,OAAO,GAAKgD,QAAQ,CAAE,CACrDtF,gBAAgB,CAACsC,OAAO,CAAGgD,QAAQ,CACnCnG,iBAAiB,CAACmG,QAAQ,CAAC,CAC3BjG,kBAAkB,CAAC,IAAI,CAAC,CACxBP,OAAO,CAACqE,GAAG,CAAC,yDAAyD,CAAEmC,QAAQ,CAAC,CAClF,CACF,CACF,CAAC,IAAM,CACL;AAAA,CAEJ,CACF,CAAE,MAAO9C,GAAG,CAAE,CACZ1D,OAAO,CAAC4D,KAAK,CAAC,wBAAwB,CAAEF,GAAG,CAAC,CAC9C,CACF,CAAC,CAEDY,EAAE,CAACmC,OAAO,CAAIxG,CAAC,EAAK,CAClB;AACA,GAAIqE,EAAE,CAACM,UAAU,CAAE,CACjB,GAAIxF,KAAK,CAAEY,OAAO,CAACqE,GAAG,CAAC,gDAAgD,CAAC,CACxE,OACF,CACArE,OAAO,CAAC4D,KAAK,CAAC,UAAU,CAAE3D,CAAC,CAAC,CAC5BU,SAAS,CAAC,iBAAiB,CAAC,CAC5B;AACA,GAAI,CAAE2D,EAAE,CAACO,KAAK,CAAC,CAAC,CAAE,CAAE,MAAOnB,GAAG,CAAE,CAAC,CACnC,CAAC,CAEDY,EAAE,CAACoC,OAAO,CAAG,IAAM,CACjB;AACA,GAAIpC,EAAE,CAACM,UAAU,CAAE,CACjB,GAAIxF,KAAK,CAAEY,OAAO,CAACqE,GAAG,CAAC,iEAAiE,CAAC,CACzF,OACF,CACA;AACA;AACA,GAAI,CAACzC,wBAAwB,CAAC4B,OAAO,EAAIxC,KAAK,CAACwC,OAAO,GAAKc,EAAE,CAAE,CAC7D7D,YAAY,CAAC,KAAK,CAAC,CACrB,CACAE,SAAS,CAAC,kBAAkB,CAAC,CAC7BK,KAAK,CAACwC,OAAO,CAAG,IAAI,CACpB,GAAIpE,KAAK,CAAEY,OAAO,CAACqE,GAAG,CAAC,gCAAgC,CAAC,CAExD;AACA,KAAM,CAAAsC,eAAe,CAAGlF,gBAAgB,CAAC+B,OAAO,EAAItE,MAAM,CAC1D;AACA6B,eAAe,CAAC,IAAI,CAAC,CAErB;AACA,GAAI,CACF,GAAI,CAACY,eAAe,CAAC6B,OAAO,CAAE,CAC5B7B,eAAe,CAAC6B,OAAO,CAAGoD,WAAW,CAAC,SAAY,CAChD,GAAI,CACF,KAAM,CAAAC,GAAG,CAAG,CAACF,eAAe,EAAIzH,MAAM,EAAI,EAAE,EAAEgD,OAAO,CAAC,eAAe,CAAE,EAAE,CAAC,CAACC,WAAW,CAAC,CAAC,CACxF,GAAI,CAAC0E,GAAG,CAAE,OACV,KAAM,CAAAzE,GAAG,mDAAAC,MAAA,CAAqDwE,GAAG,yBAAuB,CACxF,KAAM,CAAAvE,GAAG,CAAG,KAAM,CAAAC,KAAK,CAACH,GAAG,CAAC,CAC5B,GAAI,CAACE,GAAG,CAACE,EAAE,CAAE,OACb,KAAM,CAAAE,IAAI,CAAG,KAAM,CAAAJ,GAAG,CAACK,IAAI,CAAC,CAAC,CAC7B;AACA,KAAM,CAAAmE,SAAS,CAAG,EAAE,CACpB,IAAK,KAAM,CAAAhE,CAAC,GAAI,CAAAJ,IAAI,CAAE,CACpB,KAAM,CAAA2D,SAAS,CAAGvD,CAAC,CAAC,CAAC,CAAC,CACtB,GAAIuD,SAAS,GAAK,CAAC3E,qBAAqB,CAAC8B,OAAO,EAAI6C,SAAS,CAAG3E,qBAAqB,CAAC8B,OAAO,CAAC,CAAE,CAC9FsD,SAAS,CAACC,IAAI,CAACjE,CAAC,CAAC,CACnB,CACF,CACA,GAAIgE,SAAS,CAACxH,MAAM,CAAG,CAAC,CAAE,CACxB;AACAwH,SAAS,CAACE,IAAI,CAAC,CAACC,CAAC,CAAEC,CAAC,GAAKD,CAAC,CAAC,CAAC,CAAC,CAAGC,CAAC,CAAC,CAAC,CAAC,CAAC,CACrC,IAAK,KAAM,CAAApE,CAAC,GAAI,CAAAgE,SAAS,CAAE,CACzB,KAAM,CAAAjC,KAAK,CAAG9B,UAAU,CAACD,CAAC,CAAC,CAAC,CAAC,CAAC,CAC9B;AACA,GAAI3B,OAAO,CAACqC,OAAO,EAAI,IAAI,EAAIpC,QAAQ,CAACoC,OAAO,EAAI,IAAI,CAAE,SACzD;AACA,GAAInC,gBAAgB,CAACmC,OAAO,EAAI,IAAI,EAAIlC,iBAAiB,CAACkC,OAAO,EAAI,IAAI,CAAE,CACzEnC,gBAAgB,CAACmC,OAAO,CAAGrC,OAAO,CAACqC,OAAO,CAC1ClC,iBAAiB,CAACkC,OAAO,CAAGpC,QAAQ,CAACoC,OAAO,CAC9C,CACA,KAAM,CAAA2C,QAAQ,CAAGnH,SAAS,CAACqC,gBAAgB,CAACmC,OAAO,CAAEqB,KAAK,CAAE,EAAE,CAAC,CAC/D,KAAM,CAAAuB,SAAS,CAAGpH,SAAS,CAACsC,iBAAiB,CAACkC,OAAO,CAAEqB,KAAK,CAAE,GAAG,CAAC,CAClExD,gBAAgB,CAACmC,OAAO,CAAG2C,QAAQ,CACnC7E,iBAAiB,CAACkC,OAAO,CAAG4C,SAAS,CACrC;AACAjF,OAAO,CAACqC,OAAO,CAAG2C,QAAQ,CAC1B/E,QAAQ,CAACoC,OAAO,CAAG4C,SAAS,CAC5B3G,OAAO,CAAC0G,QAAQ,CAAC,CACjBxG,QAAQ,CAACyG,SAAS,CAAC,CACnB,KAAM,CAAAe,QAAQ,CAAGhB,QAAQ,CAAGC,SAAS,CAAG,MAAM,CAAG,MAAM,CACvD,GAAIlF,gBAAgB,CAACsC,OAAO,GAAK2D,QAAQ,CAAE,CACzCjG,gBAAgB,CAACsC,OAAO,CAAG2D,QAAQ,CACnC9G,iBAAiB,CAAC8G,QAAQ,CAAC,CAC3B5G,kBAAkB,CAAC,MAAM,CAAC,CAC5B,CACAmB,qBAAqB,CAAC8B,OAAO,CAAGV,CAAC,CAAC,CAAC,CAAC,CACpC;AACAjD,YAAY,CAACkD,UAAU,CAACD,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAC9BjC,mBAAmB,CAAC,IAAI,CAAC,CAC3B,CACF,CACF,CAAE,MAAOZ,CAAC,CAAE,CACV;AAAA,CAEJ,CAAC,CAAE,EAAE,CAAG,IAAI,CAAC,CAAE;AACjB,CACF,CAAE,MAAOA,CAAC,CAAE,CAAC,CAEb;AACA,KAAM,CAAAmH,OAAO,CAAG7F,oBAAoB,CAACiC,OAAO,EAAI,CAAC,CACjD,KAAM,CAAA6D,IAAI,CAAG,IAAI,CAAE;AACnB,KAAM,CAAAC,KAAK,CAAGnE,IAAI,CAACC,GAAG,CAAC,KAAK,CAAEiE,IAAI,CAAGlE,IAAI,CAACoE,GAAG,CAAC,CAAC,CAAEH,OAAO,CAAC,CAAC,CAC1D,KAAM,CAAAI,MAAM,CAAGrE,IAAI,CAACsE,KAAK,CAACtE,IAAI,CAACuE,MAAM,CAAC,CAAC,CAAG,IAAI,CAAC,CAC/CnG,oBAAoB,CAACiC,OAAO,CAAG4D,OAAO,CAAG,CAAC,CAC1C5F,iBAAiB,CAACgC,OAAO,CAAGmE,UAAU,CAAC,IAAM,CAC3CnG,iBAAiB,CAACgC,OAAO,CAAG,IAAI,CAChC,GAAI,CAACxC,KAAK,CAACwC,OAAO,CAAE,CAClB;AACA,KAAM,CAAA1B,MAAM,CAAG6E,eAAe,EAAIzH,MAAM,CACxC,GAAI,CAAE2E,OAAO,CAAC/B,MAAM,CAAC,CAAE,CAAE,MAAO7B,CAAC,CAAE,CAAE4D,OAAO,CAAC/B,MAAM,CAAC,CAAE,CACxD,CACF,CAAC,CAAEwF,KAAK,CAAGE,MAAM,CAAC,CAElB;AACA/F,gBAAgB,CAAC+B,OAAO,CAAG,IAAI,CACjC,CAAC,CACH,CAAC,CAAE,CAACtE,MAAM,CAAE2C,YAAY,CAAEzC,KAAK,CAAC,CAAC,CAEjC,KAAM,CAAAwI,UAAU,CAAG9I,WAAW,CAAC,IAAM,CACnC,GAAIkC,KAAK,CAACwC,OAAO,CAAE,CACjBxC,KAAK,CAACwC,OAAO,CAACqB,KAAK,CAAC,CAAC,CACrB7D,KAAK,CAACwC,OAAO,CAAG,IAAI,CACtB,CACA/C,YAAY,CAAC,KAAK,CAAC,CACnBE,SAAS,CAAC,cAAc,CAAC,CACzBI,eAAe,CAAC,IAAI,CAAC,CACrB,GAAIY,eAAe,CAAC6B,OAAO,CAAE,CAC3BmB,aAAa,CAAChD,eAAe,CAAC6B,OAAO,CAAC,CACtC7B,eAAe,CAAC6B,OAAO,CAAG,IAAI,CAChC,CACA;AACA,GAAI,CACFjC,oBAAoB,CAACiC,OAAO,CAAG,CAAC,CAChC,GAAIhC,iBAAiB,CAACgC,OAAO,CAAE,CAC7BkB,YAAY,CAAClD,iBAAiB,CAACgC,OAAO,CAAC,CACvChC,iBAAiB,CAACgC,OAAO,CAAG,IAAI,CAClC,CACF,CAAE,MAAOvD,CAAC,CAAE,CAAC,CACf,CAAC,CAAE,EAAE,CAAC,CAENtB,SAAS,CAAC,IAAM,CACd;AACA;AACA;AACA;AACA,GAAI,CACF;AACA,GAAI6C,iBAAiB,CAACgC,OAAO,CAAE,CAC7BkB,YAAY,CAAClD,iBAAiB,CAACgC,OAAO,CAAC,CACvChC,iBAAiB,CAACgC,OAAO,CAAG,IAAI,CAClC,CACAjC,oBAAoB,CAACiC,OAAO,CAAG,CAAC,CAEhC;AACAvC,YAAY,CAACuC,OAAO,CAAG,IAAI,CAC3B/B,gBAAgB,CAAC+B,OAAO,CAAG,IAAI,CAC/BrC,OAAO,CAACqC,OAAO,CAAG,IAAI,CACtBpC,QAAQ,CAACoC,OAAO,CAAG,IAAI,CACvB/D,OAAO,CAAC,IAAI,CAAC,CACbE,QAAQ,CAAC,IAAI,CAAC,CACdE,YAAY,CAAC,IAAI,CAAC,CAClBM,QAAQ,CAAC,IAAI,CAAC,CACdU,mBAAmB,CAAC,KAAK,CAAC,CAC1B;AACA;AACAF,SAAS,CAAC,WAAW,CAAC,CACxB,CAAE,MAAOV,CAAC,CAAE,CAAC,CACb;AACA4B,YAAY,CAAC,CAAC,CACd;AACA,MAAO,IAAM,CACX,GAAIb,KAAK,CAACwC,OAAO,CAAExC,KAAK,CAACwC,OAAO,CAACqB,KAAK,CAAC,CAAC,CACxC,GAAIlD,eAAe,CAAC6B,OAAO,CAAE,CAC3BmB,aAAa,CAAChD,eAAe,CAAC6B,OAAO,CAAC,CACtC7B,eAAe,CAAC6B,OAAO,CAAG,IAAI,CAChC,CACF,CAAC,CACH,CAAC,CAAE,CAAC3B,YAAY,CAAC,CAAC,CAElB;AACAlD,SAAS,CAAC,IAAM,CACd,GAAI+B,MAAM,GAAK,aAAa,EAAIvB,WAAW,CAAE,CAC3C;AACA0E,OAAO,CAAC,CAAC,CACX,CACA;AACF,CAAC,CAAE,CAACnD,MAAM,CAAEvB,WAAW,CAAE0E,OAAO,CAAC,CAAC,CAElC,MAAO,CACLrE,IAAI,CACJE,KAAK,CACLE,SAAS,CACTE,QAAQ,CACRc,gBAAgB,CAChBV,KAAK,CACLE,cAAc,CACdE,eAAe,CACfE,SAAS,CACTE,MAAM,CACNmD,OAAO,CACP+D,UAAU,CACV9G,YACF,CAAC,CACH","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}